專案開發紀錄與技術維護手冊 (Development Log & Maintenance Guide)

版本： DEV-v2.2 更新日期： 2025-11-27 狀態： 🟡 核心功能開發完成 / 進入整合測試階段 (Phase 6) 專案名稱： 整復師客戶資料管理系統 (Osteopathy CRM)

1. 版本演進摘要 (Version History)

v1.0 - 原型階段

    功能：基本的 HTML 結構，單一檔案的 JS 邏輯。

    限制：資料結構混亂，無模組化，LocalStorage 讀寫效率低。

v2.0 - 架構重構 (The Rescue Phase)

    核心變更：導入 分級儲存策略 (Tiered Storage)。

        customerIndex (索引)：輕量化，僅存 ID、姓名、狀態。

        customer_{id} (詳情)：獨立儲存完整資料，按需載入。

    模組化：確立 AppStorage, AppCustomerManager, AppDataManager 的命名空間與職責。

    UI 修復：SVG 人體圖示互動實作、服務紀錄五步驟流程打通。

v2.1 - 流程完善

    功能增強：

        Auto-fill：主訴部位自動帶入處理方案建議。

        資料同步：確保 UI 選擇 (UIAssessment) 與資料層 (Flow) 的同步。

        編輯模式：支援讀取舊紀錄進行修改。

v2.2 - 系統管理與優化 (Current Stable)

    後台管理：實作 settings.js，支援標籤與評估動作的 CRUD。

    資料保全：新增 DataExportService，實作完整的 JSON 備份與還原。

    效能優化：customer-profile.html 改用 無限滾動 (Infinite Scroll) 取代傳統分頁。

    Bug 修復：修復資料層語法錯誤、刪除紀錄邏輯串接。

2. 系統架構說明 (System Architecture v2.2)

2.1 資料流向
UI Layer (HTML/DOM)
   ↓ (Events)
Logic Controllers (settings.js, service-record-flow.js, customer-manager.js)
   ↓ (CRUD Calls)
Data Managers (TagManager, RecordManager, AssessmentManager)
   ↓ (Raw Data I/O)
Storage Service (storage.js) -> [LocalStorage]

2.2 核心模組職責
模組名稱,檔案位置,核心職責,v2.2 關鍵更新
StorageService,js/storage.js,底層 I/O、分級儲存、自動遷移,支援 loadCustomerIndex 與 loadCustomerDetail 分離讀取。
CustomerManager,js/customer-manager.js,顧客 CRUD、搜尋、索引更新,寫入時同時更新 Index 與 Detail 檔案。
DataManager,js/data-manager.js,標籤/動作/紀錄/匯出,新增 DataExportService、補完 Tag/Assessment 的 Update/Delete 方法。
RecordFlow,js/service-record-flow.js,服務紀錄五步驟邏輯,新增 處理方案自動帶入 (Auto-fill)、編輯模式支援 (init 參數)。
SettingsApp,js/settings.js,設定頁面 UI 邏輯,新增 完整後台控制邏輯，串接 DataManager 進行管理操作。
3. 關鍵技術決策紀錄 (Technical Decisions)

A. 無限滾動 (Infinite Scroll) 取代分頁

    原因：舊版分頁 UX 不佳，且一次讀取所有紀錄會造成 DOM 渲染卡頓。

    實作：

        使用 IntersectionObserver 監聽底部 load-more-trigger 元素。

        採用 insertAdjacentHTML('beforeend', ...) 進行高效 DOM 追加。

        檔案：customer-profile.html

B. 智慧填寫 (Auto-fill Logic)

    原因：減少整復師重複輸入部位名稱的時間。

    實作：

        在進入「處理方案 (Step 4)」時，檢查內容是否為空。

        若為空，讀取「主訴 (Step 1)」的部位 ID (如 neck)。

        透過 Mapping 轉為中文 (頸部) 並組合成建議句子填入。

        檔案：js/service-record-flow.js -> initializeTreatmentUI

C. 全資料匯出 (Full Backup)

    挑戰：資料分散在 customerIndex 和多個 customer_{id} 中。

    解決：

        DataExportService 遍歷 localStorage 所有 Key。

        識別 customer_ 開頭的 Key 進行打包。

        匯出包含時間戳記的單一 JSON 檔案 (osteopathy-backup-YYYYMMDD...json)。

        檔案：js/data-manager.js -> DataExportService

4. 檔案清單與狀態 (File Manifest)

維護或部署時，請確保以下檔案皆為最新版本：
檔案路徑	版本	狀態	備註
index.html	v2.0	✅	入口頁，含環境檢測
customer-list.html	v2.1	✅	含設定按鈕、搜尋、列表渲染
customer-profile.html	v2.2	✅	含無限滾動、刪除功能、統計圖表佔位
service-record.html	v2.0	✅	含結構化 SVG、五步驟 UI
settings.html	v1.0	✅	設定頁面骨架
js/storage.js	v2.0	✅	分級儲存核心
js/customer-manager.js	v2.0	✅	顧客邏輯
js/data-manager.js	v2.2	✅	核心更新：CRUD + 匯出匯入
js/service-record-flow.js	v2.1	✅	核心更新：Auto-fill + 編輯修正
js/settings.js	v1.0	✅	新增檔案：設定頁控制器
js/ui-assessment.js	v2.0	✅	互動邏輯

5. 待辦事項與未來規劃 (Roadmap)

🚀 P1 優先更新 (High Priority)

    一鍵複製摘要 (Smart Copy)：

        在 customer-profile.html 的紀錄卡片增加按鈕。

        將紀錄格式化為純文字 (主訴/評估/建議) 並複製到剪貼簿。

    行動裝置優化：

        微調 SVG 在手機版的操作區域。

        優化 Modal 在小螢幕的顯示。

🛠️ P2 功能擴充 (Medium Priority)

    常用套路模板 (Quick Templates)：

        在 settings.js 新增模板管理功能。

        在服務紀錄流程中加入「引用模板」按鈕。

    疼痛指數趨勢圖：

        在客戶檔案頁引入 Chart.js，視覺化呈現 discomfortLevel 的變化。

⚠️ 已知維護注意事項

    資料結構變更：若未來修改 ServiceRecord 結構，需同步更新 DataExportService 的版號 (version) 並在 importData 中加入遷移邏輯。

    瀏覽器限制：iOS Safari 的 LocalStorage 容量限制較嚴格 (約 5MB)，若圖片功能加入需改用 IndexedDB。

文件結束 - 2025/11/27