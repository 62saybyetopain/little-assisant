<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ–°å¢æœå‹™ç´€éŒ„ - å®¢æˆ¶ç®¡ç†ç³»çµ±</title>
  <link rel="stylesheet" href="styles/main.css">
  <link rel="stylesheet" href="styles/service-record.css">
  <link rel="stylesheet" href="styles/assessment-ui.css">
</head>
<body>
  <div class="page-header">
    <button class="back-btn" onclick="history.back()">
      â† è¿”å›
    </button>
    <div class="header-title">
      <h1 id="page-title">æ–°å¢æœå‹™ç´€éŒ„</h1>
      <p class="header-subtitle" id="customer-subtitle">è¼‰å…¥ä¸­...</p>
    </div>
  </div>

  <div class="page-container">
    <div class="step-navigation"></div>

    <div data-step="1" class="step-container">
      <h2>ä¸»è¨´</h2>
      <p class="step-description">æè¿°å®¢æˆ¶ä¸»è¦çš„ç—‡ç‹€æˆ–å•é¡Œ</p>

      <div class="form-group">
        <label class="form-label">
          ä¸»è¨´å…§å®¹
        </label>
        <textarea 
          name="complaint" 
          class="form-textarea"
          placeholder="è«‹è¼¸å…¥å®¢æˆ¶çš„ä¸»è¨´ç—‡ç‹€ï¼Œå¦‚ï¼šè‚©è†€é…¸ç—›ã€è…°éƒ¨ä¸é©ç­‰"
          rows="4">
        </textarea>
        <span class="form-help">è«‹ç°¡æ½”æè¿°å®¢æˆ¶çš„ä¸»è¦ç—‡ç‹€</span>
      </div>

      <div class="step-actions-bar">
         <button type="button" class="btn-secondary btn-save-record">å„²å­˜</button>
      </div>
    </div>

    <div data-step="2" class="step-container">
      <h2>ç—‡ç‹€è©•ä¼°</h2>
      <p class="step-description">è©³ç´°è¨˜éŒ„ç—‡ç‹€ã€è‚Œç¾¤æ¨™ç±¤èˆ‡è©•ä¼°çµæœ</p>

      <div class="section-divider">
        <h3>èº«é«”éƒ¨ä½é¸æ“‡</h3>
      </div>
      <div class="ui-assessment-body-diagram">
        <div class="body-diagram-wrapper">
          <svg id="body-diagram-front" viewBox="0 0 320 420" xmlns="http://www.w3.org/2000/svg">
            <style>
              .label-text { font-size: 12px; fill: #666; font-weight: bold; text-anchor: middle; pointer-events: none; }
              .body-part { fill: #e0e0e0; stroke: #999; stroke-width: 1; cursor: pointer; transition: fill 0.2s; }
              .body-part:hover { fill: #b3d9ff; }
              .body-part.selected { fill: #4A90E2; stroke: #2171c7; }
            </style>
            
            <text x="80" y="20" class="label-text">æ­£é¢ (Front)</text>
            <text x="240" y="20" class="label-text">èƒŒé¢ (Back)</text>

            <g transform="translate(0, 30)">
              <circle class="body-part" data-part="head" cx="80" cy="25" r="20" />
              <rect class="body-part" data-part="neck" x="70" y="45" width="20" height="15" rx="5" />
              <path class="body-part" data-part="left-shoulder" d="M70 60 L40 70 L45 90 L70 80 Z" />
              <path class="body-part" data-part="right-shoulder" d="M90 60 L120 70 L115 90 L90 80 Z" />
              <rect class="body-part" data-part="chest" x="60" y="80" width="40" height="40" rx="5" />
              <rect class="body-part" data-part="abdomen" x="65" y="125" width="30" height="45" rx="5" />
              
              <rect class="body-part" data-part="left-arm" x="35" y="95" width="15" height="50" rx="5" />
              <rect class="body-part" data-part="left-arm" x="35" y="150" width="15" height="45" rx="5" /> <rect class="body-part" data-part="right-arm" x="110" y="95" width="15" height="50" rx="5" />
              <rect class="body-part" data-part="right-arm" x="110" y="150" width="15" height="45" rx="5" /> <rect class="body-part" data-part="left-leg" x="55" y="180" width="20" height="70" rx="5" /> <circle class="body-part" data-part="left-knee" cx="65" cy="260" r="10" /> <rect class="body-part" data-part="left-calf" x="58" y="275" width="14" height="60" rx="5" /> <rect class="body-part" data-part="left-ankle" x="55" y="340" width="20" height="10" rx="3" /> <rect class="body-part" data-part="right-leg" x="85" y="180" width="20" height="70" rx="5" /> <circle class="body-part" data-part="right-knee" cx="95" cy="260" r="10" /> <rect class="body-part" data-part="right-calf" x="88" y="275" width="14" height="60" rx="5" /> <rect class="body-part" data-part="right-ankle" x="85" y="340" width="20" height="10" rx="3" /> </g>

            <g transform="translate(160, 30)">
              <circle class="body-part" data-part="head" cx="80" cy="25" r="20" />
              <rect class="body-part" data-part="neck" x="70" y="45" width="20" height="15" rx="5" />
              <path class="body-part" data-part="left-shoulder" d="M70 60 L40 70 L45 90 L70 80 Z" />
              <path class="body-part" data-part="right-shoulder" d="M90 60 L120 70 L115 90 L90 80 Z" />
              
              <rect class="body-part" data-part="upper-back" x="60" y="80" width="40" height="50" rx="5" />
              <rect class="body-part" data-part="lower-back" x="65" y="135" width="30" height="25" rx="5" />
              <rect class="body-part" data-part="hip" x="60" y="165" width="40" height="25" rx="5" />

              <rect class="body-part" data-part="left-arm" x="35" y="95" width="15" height="50" rx="5" />
              <rect class="body-part" data-part="left-arm" x="35" y="150" width="15" height="45" rx="5" />
              <rect class="body-part" data-part="right-arm" x="110" y="95" width="15" height="50" rx="5" />
              <rect class="body-part" data-part="right-arm" x="110" y="150" width="15" height="45" rx="5" />

              <rect class="body-part" data-part="left-leg" x="55" y="195" width="20" height="70" rx="5" />
              <rect class="body-part" data-part="left-calf" x="58" y="275" width="14" height="60" rx="5" />
              
              <rect class="body-part" data-part="right-leg" x="85" y="195" width="20" height="70" rx="5" />
              <rect class="body-part" data-part="right-calf" x="88" y="275" width="14" height="60" rx="5" />
            </g>
          </svg>
        </div>
        <div id="list-mode-hint" style="display: none;"></div>
      </div>

      <div class="section-divider">
        <h3>ç›¸é—œè‚Œç¾¤æ¨™ç±¤</h3>
      </div>
      <div id="muscle-tags-container" class="muscle-tags-container">
        </div>

      <div class="section-divider">
        <h3>è©•ä¼°å‹•ä½œçµæœ</h3>
      </div>
      <div id="assessment-container" class="assessment-container">
        </div>

      <div class="step-actions-bar">
         <button type="button" class="btn-secondary btn-save-record">å„²å­˜</button>
      </div>
    </div>

    <div data-step="3" class="step-container">
      <h2>è©•ä¼°çµæœ</h2>
      <p class="step-description">æ•´ç†è©•ä¼°çµæœèˆ‡åˆæ­¥è¨ºæ–·</p>

      <div class="assessment-summary">
        <h3>è©•ä¼°çµæœæ‘˜è¦</h3>
        <div id="assessment-summary-content" class="assessment-summary-content">
          <p class="hint">æš«ç„¡è©•ä¼°çµæœï¼Œè«‹è¿”å›ä¸Šä¸€æ­¥å®Œæˆè©•ä¼°</p>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">
          åˆæ­¥è¨ºæ–·èˆ‡ç™¼ç¾
        </label>
        <textarea 
          name="findings" 
          class="form-textarea"
          placeholder="æ ¹æ“šè©•ä¼°çµæœï¼Œè¨˜éŒ„åˆæ­¥è¨ºæ–·å’Œä¸»è¦ç™¼ç¾"
          rows="5">
        </textarea>
        <span class="form-help">ç¸½çµè©•ä¼°çš„ä¸»è¦ç™¼ç¾å’Œåˆæ­¥è¨ºæ–·</span>
      </div>

      <div class="step-actions-bar">
         <button type="button" class="btn-secondary btn-save-record">å„²å­˜</button>
      </div>
    </div>

    <div data-step="4" class="step-container">
      <h2>è™•ç†æ–¹æ¡ˆ</h2>
      <p class="step-description">å»ºè­°æ²»ç™‚æ–¹æ¡ˆèˆ‡è™•ç†æ–¹å¼</p>

      <div class="form-group">
        <label class="form-label">
          æ²»ç™‚è¨ˆç•«
        </label>
        <textarea 
          name="treatment-plan" 
          class="form-textarea"
          placeholder="è©³è¿°å»ºè­°çš„æ²»ç™‚æ–¹æ¡ˆã€æ‰‹æ³•ã€é »ç‡ç­‰"
          rows="5">
        </textarea>
      </div>

      <div class="form-group">
        <label class="form-label">
          å»ºè­°èˆ‡æ³¨æ„äº‹é …
        </label>
        <textarea 
          name="recommendations" 
          class="form-textarea"
          placeholder="æä¾›çµ¦å®¢æˆ¶çš„å»ºè­°ï¼Œå¦‚ï¼šå±…å®¶ä¿å¥ã€é‹å‹•å»ºè­°ã€æ³¨æ„äº‹é …ç­‰"
          rows="4">
        </textarea>
      </div>
      <div class="step-actions-bar">
         <button type="button" class="btn-secondary btn-save-record">å„²å­˜</button>
      </div>
    </div>

    <div data-step="5" class="step-container">
      <h2>å®¢æˆ¶åé¥‹</h2>
      <p class="step-description">è¨˜éŒ„å®¢æˆ¶åæ‡‰èˆ‡å¾ŒçºŒå»ºè­°</p>

      <div class="form-group">
        <label class="form-label">
          å®¢æˆ¶åé¥‹
        </label>
        <textarea 
          name="feedback" 
          class="form-textarea"
          placeholder="è¨˜éŒ„å®¢æˆ¶å°æ²»ç™‚çš„åæ‡‰ã€ç—‡ç‹€æ”¹å–„æƒ…æ³ç­‰"
          rows="4">
        </textarea>
      </div>

      <div class="form-group">
        <label class="form-label">
          å¾ŒçºŒå»ºè­°èˆ‡é ç´„
        </label>
        <textarea 
          name="next-steps" 
          class="form-textarea"
          placeholder="å»ºè­°ä¸‹æ¬¡é ç´„æ™‚é–“ã€å¾ŒçºŒæ²»ç™‚è¨ˆç•«ç­‰"
          rows="4">
        </textarea>
      </div>
      <div class="step-actions-bar">
         <button type="button" class="btn-secondary btn-save-record">å„²å­˜</button>
      </div
    </div>

    <div class="step-buttons"></div>

    <div class="action-buttons"></div>
  </div>

  <div class="alert-container"></div>

<div id="modal-template-selector" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="tpl-modal-title">ç™¼ç¾é©ç”¨æ¨¡æ¿</h2>
        <button class="close-btn" onclick="closeModal('modal-template-selector')">Ã—</button>
      </div>
      
      <div class="modal-body">
        <div id="tpl-select-container" class="form-group" style="display:none;">
          <label class="form-label" style="font-weight:bold;">é¸æ“‡è¦å¥—ç”¨çš„æ¨¡æ¿ï¼š</label>
          <select id="tpl-select" class="form-select">
            </select>
        </div>

        <form id="form-apply-template">
          
          <div class="template-section">
            <h3 class="tpl-section-title">æ–‡å­—å…§å®¹ (å‹¾é¸å¾ŒåŠ å…¥æ¬„ä½)</h3>
            
            <div class="tpl-group">
              <label>ä¸»è¨´ (Complaints)</label>
              <div id="tpl-check-complaints" class="checkbox-list"></div>
            </div>
            
            <div class="tpl-group">
              <label>è©•ä¼°ç™¼ç¾ (Findings)</label>
              <div id="tpl-check-findings" class="checkbox-list"></div>
            </div>

            <div class="tpl-group">
              <label>è™•ç†æ–¹å¼ (Treatments)</label>
              <div id="tpl-check-treatments" class="checkbox-list"></div>
            </div>

            <div class="tpl-group">
              <label>å»ºè­° (Recommendations)</label>
              <div id="tpl-check-recommendations" class="checkbox-list"></div>
            </div>
          </div>

          <hr class="divider">

          <div class="template-section">
            <h3 class="tpl-section-title">ç³»çµ±é—œè¯ (è‡ªå‹•é¸å–æ¨™ç±¤/å‹•ä½œ)</h3>
            
            <div class="tpl-group">
              <label>ç›¸é—œè‚Œç¾¤æ¨™ç±¤</label>
              <div id="tpl-check-muscles" class="checkbox-list"></div>
            </div>

            <div class="tpl-group">
              <label>è©•ä¼°å‹•ä½œæ¸…å–®</label>
              <div id="tpl-check-assessments" class="checkbox-list"></div>
            </div>
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn-secondary" onclick="closeModal('modal-template-selector')">å–æ¶ˆ</button>
        <button type="button" class="btn-primary" id="btn-apply-template">ç¢ºèªå¥—ç”¨</button>
      </div>
    </div>
  </div>

  <script src="js/storage.js"></script>
  <script src="js/customer-manager.js"></script>
  <script src="js/data-manager.js"></script>

  <script src="js/ui-assessment.js"></script>

  <script src="js/service-record-flow.js"></script>

  <script>
    /**
     * æœå‹™ç´€éŒ„é é¢åˆå§‹åŒ–
     */
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('âœ… æœå‹™ç´€éŒ„é é¢è¼‰å…¥');

      try {
        const urlParams = new URLSearchParams(window.location.search);
        const customerId = urlParams.get('customerId');

        if (!customerId) {
          showAlert('ç„¡æ•ˆçš„å®¢æˆ¶ ID', 'error');
          setTimeout(() => {
            window.location.href = 'customer-list.html';
          }, 2000);
          return;
        }

        if (!window.AppCustomerManager) {
          console.error('âŒ è³‡æ–™ç®¡ç†ç³»çµ±æœªæ­£ç¢ºåˆå§‹åŒ–');
          showAlert('ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢', 'error');
          return;
        }

        const customer = window.AppCustomerManager.getCustomerById(customerId);
        if (!customer) {
          showAlert('æ‰¾ä¸åˆ°è©²å®¢æˆ¶', 'error');
          setTimeout(() => {
            window.location.href = 'customer-list.html';
          }, 2000);
          return;
        }

        document.getElementById('page-title').textContent = `æ–°å¢æœå‹™ç´€éŒ„ - ${customer.name}`;
        document.getElementById('customer-subtitle').textContent = 
          `å®¢æˆ¶ï¼š${customer.name} | æš±ç¨±ï¼š${customer.nickname} | é›»è©±æœ«ä¸‰ç¢¼ï¼š***${customer.phoneLastThree}`;

        if (window.AppUIAssessment) {
          console.log('ğŸ”„ åˆå§‹åŒ– UIAssessment...');
          await window.AppUIAssessment.init({
            bodyDiagramId: 'body-diagram-front',
            muscleTagContainerId: 'muscle-tags-container',
            assessmentContainerId: 'assessment-container'
          });
        }

        if (!window.AppServiceRecordFlow) {
          console.error('âŒ ServiceRecordFlow æœªå®šç¾©');
          return;
        }

        console.log('ğŸ”„ åˆå§‹åŒ– ServiceRecordFlow...');
        await window.AppServiceRecordFlow.init(customerId);

        console.log('âœ… é é¢åˆå§‹åŒ–å®Œæˆ');

        document.addEventListener('serviceRecordSaved', (e) => {
          console.log('âœ… æœå‹™ç´€éŒ„å·²ä¿å­˜ï¼š', e.detail.recordId);
          showAlert('æœå‹™ç´€éŒ„å·²æˆåŠŸä¿å­˜ï¼', 'success');

          setTimeout(() => {
            window.location.href = `customer-profile.html?id=${customerId}`;
          }, 2000);
        });

      } catch (error) {
        console.error('âŒ é é¢åˆå§‹åŒ–éŒ¯èª¤ï¼š', error);
        showAlert(`åˆå§‹åŒ–éŒ¯èª¤ï¼š${error.message}`, 'error');
      }
    });

    function showAlert(message, type = 'info') {
      let alertContainer = document.querySelector('.alert-container');
      if (!alertContainer) {
        alertContainer = document.createElement('div');
        alertContainer.className = 'alert-container';
        document.body.insertBefore(alertContainer, document.body.firstChild);
      }

      const alert = document.createElement('div');
      alert.className = `alert alert-${type}`;
      alert.setAttribute('role', 'alert');
      alert.textContent = message;

      alertContainer.appendChild(alert);

      setTimeout(() => {
        alert.remove();
      }, 3000);
    }

    window.showAlert = showAlert;
    window.showLoading = showLoading;
    window.hideLoading = hideLoading;

// [æ–°å¢] Modal æ§åˆ¶å‡½å¼
    window.openModal = function(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) modal.classList.add('show');
    };

    window.closeModal = function(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) modal.classList.remove('show');
    };
  </script>

  <style>
    /* é é¢ç‰¹å®šæ¨£å¼ */
    .page-header {
      background: white;
      padding: 20px;
      border-bottom: 1px solid var(--border-light);
      position: sticky;
      top: 0;
      z-index: 20;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
    }

    .back-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: transparent;
      border: none;
      color: var(--primary-color);
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      margin-bottom: 12px;
    }

    .back-btn:hover {
      text-decoration: underline;
    }

    .header-title h1 {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0;
    }

    .header-subtitle {
      font-size: 14px;
      color: var(--text-secondary);
      margin: 4px 0 0 0;
    }

    .page-container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 24px 16px;
    }

    .section-divider {
      margin-top: 24px;
      margin-bottom: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border-light);
    }

    .section-divider h3 {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
    }

    .form-textarea {
      width: 100%;
      padding: var(--spacing-md);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-md);
      font-size: 14px;
      font-family: inherit;
      color: var(--text-primary);
      resize: vertical;
      transition: all var(--transition-base);
    }

    .form-textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    @media (max-width: 768px) {
      .page-container {
        padding: 16px 12px;
      }

      .header-title h1 {
        font-size: 20px;
      }

      .header-subtitle {
        font-size: 12px;
      }
    }
/* [æ–°å¢] æ¨¡æ¿é¸æ“‡å™¨ Modal ç‰¹å®šæ¨£å¼ */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 8px;
      width: 90%;
      max-width: 600px;
      max-height: 85vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-light);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 18px;
      color: var(--text-primary);
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #999;
    }

    .modal-body {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }

    .modal-footer {
      padding: 16px 20px;
      border-top: 1px solid var(--border-light);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      background: #f9fafb;
      border-radius: 0 0 8px 8px;
    }

    /* æ¨¡æ¿å…§å®¹æ’ç‰ˆ */
    .tpl-section-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--primary-color);
      margin-bottom: 12px;
      padding-left: 8px;
      border-left: 4px solid var(--primary-color);
    }

    .tpl-group {
      margin-bottom: 16px;
    }

    .tpl-group label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }

    .checkbox-list {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
      background: #f8fafc;
      padding: 10px;
      border-radius: 6px;
    }
    
    .checkbox-item {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      font-size: 14px;
      cursor: pointer;
    }

    .checkbox-item input[type="checkbox"] {
      margin-top: 3px;
    }

    .form-select {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--border-light);
      border-radius: 4px;
      font-size: 14px;
      background-color: white;
    }

    .divider {
      border: 0;
      border-top: 1px solid var(--border-light);
      margin: 20px 0;
    }

    .btn-primary {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
    }

    .btn-secondary {
      background: white;
      border: 1px solid var(--border-light);
      color: var(--text-primary);
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
    }
   /* æ¯ä¸€æ­¥é©Ÿä¸‹æ–¹çš„æŒ‰éˆ•åˆ— */
    .step-actions-bar {
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px dashed var(--border-light);
        display: flex;
        justify-content: flex-end;
    }
    
    /*è®“æ­¥é©ŸæŒ‡ç¤ºå™¨çœ‹èµ·ä¾†å¯ä»¥é»æ“Š */
    .step-indicator {
        cursor: pointer; 
    }
  </style>
</body>
</html>