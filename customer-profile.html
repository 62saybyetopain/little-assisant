<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å®¢æˆ¶æª”æ¡ˆç®¡ç†ç³»çµ±</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --primary-color: #2196F3;
      --primary-hover: #1976D2;
      --text-primary: #212121;
      --text-secondary: #666666;
      --border-color: #E0E0E0;
      --background-primary: #FFFFFF;
      --background-secondary: #F5F5F5;
      --success: #4CAF50;
      --danger: #F44336;
      --warning: #FF9800;
    }
    body { font-family: system-ui, -apple-system, sans-serif; background: var(--background-secondary); color: var(--text-primary); }

    /* Modal å½ˆçª—æ¨£å¼*/
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex; align-items: center; justify-content: center;
      z-index: var(--z-overlay); backdrop-filter: blur(2px);
    }
    .modal-content {
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      max-height: 90vh; overflow-y: auto;
    }

    .profile-header { background: var(--background-primary); padding: 16px; border-bottom: 1px solid var(--border-color); position: sticky; top: 0; z-index: var(--z-sticky); box-shadow: 0 2px 4px rgba(0, 0, 0, 0.06); }
    .header-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
    .back-btn { display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: transparent; border: none; color: var(--primary-color); font-size: 14px; font-weight: 500; cursor: pointer; border-radius: 6px; transition: background 0.2s; }
    .back-btn:hover { background: var(--background-secondary); }
    .icon-btn { padding: 8px 12px; background: var(--background-secondary); border: none; color: var(--text-primary); font-size: 14px; cursor: pointer; border-radius: 6px; transition: all 0.2s; }
    .icon-btn:hover { background: var(--border-color); }
    .header-title { display: flex; align-items: baseline; gap: 12px; }
    .customer-name { font-size: 24px; font-weight: 600; }
    .customer-nickname { font-size: 14px; color: var(--text-secondary); }
    .profile-container { max-width: 900px; margin: 0 auto; padding: 16px; }
    
    /* å¡ç‰‡èˆ‡ç¶²æ ¼ */
    .card { background: var(--background-primary); border-radius: 12px; padding: 20px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06); }
    .card-title { font-size: 18px; font-weight: 600; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid var(--border-color); }
    .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; padding: 10px 0; }
    .info-item { display: flex; flex-direction: column; padding: 12px; background: #fff; border: 1px solid var(--border-color); border-radius: 8px; }
    .info-label { font-size: 12px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 4px; }
    .info-value { font-size: 16px; font-weight: 500; }
    
    /* çµ±è¨ˆèˆ‡æ¨™ç±¤ */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin-bottom: 16px; }
    .stat-card { background: var(--background-secondary); padding: 16px; border-radius: 8px; text-align: center; border-left: 3px solid var(--primary-color); }
    .stat-value { font-size: 28px; font-weight: 700; color: var(--primary-color); }
    .stat-label { font-size: 12px; color: var(--text-secondary); }
    .tags-section { display: none; }
    .tags-section.show { display: block; }
    .tags-group { margin-bottom: 16px; }
    .tags-group-title { font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px; }
    .tags-list { display: flex; flex-wrap: wrap; gap: 8px; }
    .tag { padding: 6px 12px; border-radius: 16px; font-size: 13px; font-weight: 500; }
    .tag.health { background: #FFE8E8; color: #D32F2F; }
    .tag.personality { background: #E3F2FD; color: #1976D2; }
    .tag.interest { background: #F3E5F5; color: #7B1FA2; }

    /* æŒ‰éˆ•èˆ‡åˆ—è¡¨ */
    .btn { padding: 12px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
    .btn-primary { background: var(--primary-color); color: white; width: 100%; }
    .btn-primary:hover { background: var(--primary-hover); }
    .filter-bar { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
    .filter-input, .filter-select { padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px; }
    .records-list { display: flex; flex-direction: column; gap: 12px; }
    .record-item { padding: 16px; border-left: 3px solid var(--primary-color); background: var(--background-secondary); border-radius: 8px; cursor: pointer; transition: all 0.2s; }
    .record-item:hover { background: var(--border-color); }
    .record-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
    .record-date { font-size: 14px; font-weight: 600; color: var(--primary-color); }
    .record-actions { display: flex; gap: 8px; }
    .record-action-btn { padding: 4px 12px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 12px; cursor: pointer; background: white; color: var(--text-secondary); }
    .record-action-btn:hover { border-color: var(--primary-color); color: var(--primary-color); }
    .record-summary { font-size: 14px; color: var(--text-secondary); margin-bottom: 8px; }
    .record-parts { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
    .part-tag { padding: 4px 10px; background: white; border: 1px solid var(--border-color); border-radius: 4px; font-size: 12px; color: var(--text-secondary); }
    
    .empty-state { text-align: center; padding: 40px 20px; }
    .empty-icon { font-size: 48px; margin-bottom: 12px; }
    .load-more-trigger { display: flex; justify-content: center; align-items: center; padding: 20px; gap: 10px; color: var(--text-secondary); font-size: 14px; }
    .loading-spinner { width: 18px; height: 18px; border: 2px solid var(--border-color); border-top-color: var(--primary-color); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .toast { position: fixed; bottom: 20px; right: 20px; padding: 12px 20px; background: var(--text-primary); color: white; border-radius: 8px; font-size: 14px; z-index: var(--z-toast); animation: slideUp 0.3s ease-out; }
    .toast.success { background: var(--success); }
    .toast.error { background: var(--danger); }
    .toast.warning { background: var(--warning); }
    @keyframes slideUp { from { transform: translateY(100px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    @media (max-width: 768px) {
      .filter-bar { grid-template-columns: 1fr; }
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
      .profile-container { padding: 12px; }
    }
  </style>
</head>
<body>
  <div class="profile-header">
    <div class="header-top">
      <button class="back-btn" id="back-btn">â† è¿”å›åˆ—è¡¨</button>
      <div class="header-actions"></div>
    </div>
    <div class="header-title">
      <span class="customer-name" id="customer-name">è¼‰å…¥ä¸­...</span>
      <span class="customer-nickname" id="customer-nickname"></span>
    </div>
  </div>

  <div class="profile-container">
    <div class="card">
      <div class="card-title" style="display:flex; justify-content:space-between; align-items:center;">
        <span>ğŸ“‹ åŸºæœ¬è³‡è¨Š</span>
        <button class="icon-btn" id="edit-btn" title="ç·¨è¼¯è³‡æ–™">âœï¸</button>
      </div>
      <div class="info-grid" id="basic-info-grid"></div>
    </div>

    <div class="card">
      <div class="card-title">ğŸ“Š çµ±è¨ˆè³‡è¨Š</div>
      <div class="stats-grid" id="stats-grid"></div>
    </div>

    <div class="card tags-section" id="tags-section">
      <div class="card-title">ğŸ·ï¸ ç‰¹æ®Šæ¨™ç±¤</div>
      <div id="tags-content"></div>
    </div>

    <button class="btn btn-primary" id="add-record-btn">
      + æ–°å¢æœå‹™ç´€éŒ„
    </button>

    <div class="card">
      <div class="card-title">ğŸ“… æœå‹™ç´€éŒ„æ­·å²</div>
      <div class="filter-bar">
        <input type="text" class="filter-input" id="search-input" placeholder="æœå°‹ä¸»è¨´æˆ–è¨ºæ–·...">
        <select class="filter-select" id="sort-select">
          <option value="newest">æœ€æ–°å„ªå…ˆ</option>
          <option value="oldest">æœ€èˆŠå„ªå…ˆ</option>
        </select>
      </div>
      <div id="records-container" class="records-list"></div>
      <div id="load-more-trigger" class="load-more-trigger" style="display: none;">
        <span class="loading-spinner"></span>
        <span class="loading-text">è¼‰å…¥æ›´å¤š...</span>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script src="js/storage.js"></script>
  <script src="js/customer-manager.js"></script>
  <script src="js/data-manager.js"></script>
  <script src="js/ui.js"></script>
  
  <script src="js/app.js"></script>
  
  <script>
    // ===== å…¨åŸŸè®Šæ•¸ =====
    const urlParams = new URLSearchParams(window.location.search);
    const customerId = urlParams.get('id');
    
    // ç„¡é™æ»¾å‹•ç›¸é—œè®Šæ•¸
    let allRecords = [];
    let filteredRecords = [];
    let displayedRecords = [];
    const batchSize = 10;
    let isLoading = false;
    let observer;

    // ===== åˆå§‹åŒ– =====
    document.addEventListener('DOMContentLoaded', () => {
      console.log('ğŸš€ é¡§å®¢æª”æ¡ˆé é¢ç­‰å¾…æ ¸å¿ƒå°±ç·’...');
      const bootPage = () => {
        if (!customerId) {
          showToast('ç„¡æ•ˆçš„å®¢æˆ¶ ID', 'error');
          setTimeout(() => window.location.href = 'customer-list.html', 1500);
          return;
        }
        if (!window.AppCustomerManager || !window.AppRecordManager) {
             console.error('Managers not loaded');
             showToast('ç³»çµ±è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†', 'error');
             return;
        }

        loadCustomerProfile();
        attachEventListeners();
      };
    //ç›£è½ app-ready äº‹ä»¶
      if (window.isAppReady) {
        bootPage();
      } else {
        document.addEventListener('app-ready', bootPage);
      }
    });

    // ===== å…¨åŸŸå‡½å¼: è·³è½‰æ–°å¢é é¢ =====
    // å®šç¾©åœ¨ window ç‰©ä»¶ä¸Šä»¥ä¾› HTML onclick ä½¿ç”¨ (å¦‚æœæœ‰éœ€è¦)
    // ä½†æˆ‘å€‘ä¸»è¦ä½¿ç”¨ addEventListener
    window.goToAddRecord = function() {
      if (!customerId) {
        showToast('éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°é¡§å®¢ ID', 'error');
        return;
      }
      window.location.href = `service-record.html?customerId=${customerId}`;
    };

    // ===== è¼‰å…¥å®¢æˆ¶è³‡æ–™ =====
    function loadCustomerProfile() {
      const customer = window.AppCustomerManager.getCustomerById(customerId);

      if (!customer) {
        showToast('æ‰¾ä¸åˆ°è©²å®¢æˆ¶è³‡æ–™', 'error');
        return;
      }

      renderCustomerInfo(customer);
      loadServiceRecords(customerId);
    }

    // ===== æ¸²æŸ“å®¢æˆ¶è³‡è¨Š =====
    function renderCustomerInfo(customer) {
      document.title = `${customer.name} - å®¢æˆ¶æª”æ¡ˆ`;
      document.getElementById('customer-name').textContent = customer.name;
      document.getElementById('customer-nickname').textContent = customer.nickname ? `(${customer.nickname})` : '';

      const basicInfo = [
        { label: 'æš±ç¨±', value: customer.nickname || '-' },
        { label: 'é›»è©±æœ«ä¸‰ç¢¼', value: `***${customer.phoneLastThree}` },
        { label: 'æ€§åˆ¥', value: formatGender(customer.gender) },
        { label: 'å¹´é½¡', value: customer.age !== null ? `${customer.age} æ­²` : '-' },
        { label: 'å±…ä½åœ°', value: customer.location || '-' },
        { label: 'è·æ¥­', value: customer.occupation || '-' },
        { label: 'å»ºæª”æ—¥æœŸ', value: formatDate(customer.createdAt) }
      ];

      const basicInfoHtml = basicInfo.map(item => `
        <div class="info-item">
          <div class="info-label">${item.label}</div>
          <div class="info-value">${window.escapeHtml(item.value)}</div>
        </div>
      `).join('');

      document.getElementById('basic-info-grid').innerHTML = basicInfoHtml;

      // çµ±è¨ˆè³‡è¨Š
      let stats = { totalServices: 0, lastServiceDate: null, daysSinceLastService: null };
      if (window.AppRecordManager.calculateStats) {
          stats = window.AppRecordManager.calculateStats(customerId);
      }

      const statsHtml = `
        <div class="stat-card">
          <div class="stat-value">${stats.totalServices}</div>
          <div class="stat-label">ç¸½æœå‹™æ¬¡æ•¸</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${stats.lastServiceDate ? formatDate(stats.lastServiceDate) : '-'}</div>
          <div class="stat-label">æœ€å¾Œæœå‹™</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${stats.daysSinceLastService !== null ? stats.daysSinceLastService : '-'}</div>
          <div class="stat-label">è·ä»Šå¤©æ•¸</div>
        </div>
      `;

      document.getElementById('stats-grid').innerHTML = statsHtml;

      const hasTags = (customer.healthTags?.length || 0) > 0 || 
                      (customer.personalityTags?.length || 0) > 0 ||
                      (customer.interestTags?.length || 0) > 0;

      if (hasTags) {
        renderTags(customer);
        document.getElementById('tags-section').classList.add('show');
      }
    }

    function renderTags(customer) {
      let html = '';
      // é‡å°æ¯å€‹ tag é€²è¡Œ escapeHtml è½‰ç¾©
      if (customer.healthTags?.length > 0) {
        html += `<div class="tags-group"><div class="tags-group-title">å¥åº·ç‹€æ…‹</div><div class="tags-list">${customer.healthTags.map(tag => `<span class="tag health">${window.escapeHtml(tag)}</span>`).join('')}</div></div>`;
      }
      if (customer.personalityTags?.length > 0) {
        html += `<div class="tags-group"><div class="tags-group-title">å€‹æ€§ç‰¹è³ª</div><div class="tags-list">${customer.personalityTags.map(tag => `<span class="tag personality">${window.escapeHtml(tag)}</span>`).join('')}</div></div>`;
      }
      if (customer.interestTags?.length > 0) {
        html += `<div class="tags-group"><div class="tags-group-title">èˆˆè¶£</div><div class="tags-list">${customer.interestTags.map(tag => `<span class="tag interest">${window.escapeHtml(tag)}</span>`).join('')}</div></div>`;
      }
      document.getElementById('tags-content').innerHTML = html;
    }

    // ===== è¼‰å…¥æœå‹™ç´€éŒ„ =====
    function loadServiceRecords(customerId) {
      if (window.AppRecordManager.getRecords) {
          allRecords = window.AppRecordManager.getRecords(customerId);
      } else {
          allRecords = [];
      }
      filteredRecords = [...allRecords];
      renderRecords(false);
    }

    function getRecordText(record) {
      // å„ªå…ˆè®€å– v2.1 (Steps) çµæ§‹
      if (record.steps?.chiefComplaint?.complaint) return record.steps.chiefComplaint.complaint;
      // å…¶æ¬¡ v2.0 çµæ§‹
      if (record.chiefComplaint?.notes) return record.chiefComplaint.notes;
      // æœ€å¾Œ v1.0 çµæ§‹
      return record.complaint || '';
    }

    function getRecordBodyParts(record) {
      if (record.steps?.chiefComplaint?.bodyParts?.length > 0) return record.steps.chiefComplaint.bodyParts;
      if (record.chiefComplaint?.bodyParts?.length > 0) return record.chiefComplaint.bodyParts;
      return record.bodyParts || [];
    }

    function applyFilters() {
      const searchText = document.getElementById('search-input').value.toLowerCase();
      const sortOrder = document.getElementById('sort-select').value;

      filteredRecords = allRecords.filter(record => {
        // ä½¿ç”¨çµ±ä¸€è®€å–å™¨
        const note = getRecordText(record);
        return note.toLowerCase().includes(searchText);
      });

      if (sortOrder === 'oldest') {
        filteredRecords.sort((a, b) => new Date(a.createdAt || a.date) - new Date(b.createdAt || b.date));
      } else {
        filteredRecords.sort((a, b) => new Date(b.createdAt || b.date) - new Date(a.createdAt || a.date));
      }
      renderRecords(false);
    }

    function renderRecords(isAppend = false) {
      const container = document.getElementById('records-container');
      const trigger = document.getElementById('load-more-trigger');

      if (filteredRecords.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">ğŸ“­</div>
            <div class="empty-title">å°šç„¡æœå‹™ç´€éŒ„</div>
            <div class="empty-description">é»æ“Šä¸Šæ–¹æŒ‰éˆ•æ–°å¢ç¬¬ä¸€ç­†æœå‹™ç´€éŒ„</div>
          </div>
        `;
        trigger.style.display = 'none';
        return;
      }

      if (!isAppend) {
        container.innerHTML = '';
        displayedRecords = [];
        window.scrollTo(0, 0);
      }

      const currentCount = displayedRecords.length;
      const nextBatch = filteredRecords.slice(currentCount, currentCount + batchSize);
      
      if (nextBatch.length === 0) {
        trigger.style.display = 'none';
        return;
      }

      const html = nextBatch.map(record => {
        const summaryText = getRecordText(record) || 'ç„¡ä¸»è¨´ç´€éŒ„';
        const bodyParts = getRecordBodyParts(record);
        
        // é å…ˆè™•ç†è®Šæ•¸ï¼Œç¢ºä¿å…§å®¹èˆ‡å±¬æ€§éƒ½å®‰å…¨
        const safeId = window.escapeHtml(record.id);
        const safeSummary = window.escapeHtml(summaryText);
        
        return `
        <div class="record-item" data-id="${safeId}" onclick="viewRecord(this.dataset.id)">
          <div class="record-header">
            <div class="record-date">${formatDateTime(record.createdAt || record.date)}</div>
            <div class="record-actions">
              <button class="record-action-btn copy-btn" 
                      data-id="${safeId}"
                      onclick="event.stopPropagation(); copyRecordSummary(this.dataset.id)" 
                      title="è¤‡è£½æ‘˜è¦">ğŸ“‹ æ‘˜è¦</button>
                      
              <button class="record-action-btn" 
                      data-id="${safeId}"
                      onclick="event.stopPropagation(); editRecord(this.dataset.id)">ç·¨è¼¯</button>
                      
              <button class="record-action-btn" 
                      data-id="${safeId}"
                      onclick="event.stopPropagation(); deleteRecord(this.dataset.id)">åˆªé™¤</button>
            </div>
          </div>
          <div class="record-summary">
            <strong>ä¸»è¨´ï¼š</strong> ${safeSummary.substring(0, 100)}${safeSummary.length > 100 ? '...' : ''}
          </div>
          ${bodyParts.length > 0 ? `
            <div class="record-parts">
              ${bodyParts.map(part => `<span class="part-tag">${window.escapeHtml(part)}</span>`).join('')}
            </div>
          ` : ''}
        </div>
      `;
      }).join('');

      container.insertAdjacentHTML('beforeend', html);
      displayedRecords = [...displayedRecords, ...nextBatch];

      if (displayedRecords.length < filteredRecords.length) {
        trigger.style.display = 'flex';
        setupIntersectionObserver();
      } else {
        trigger.style.display = 'none';
        if (observer) observer.disconnect();
      }
      isLoading = false;
    }

    function copyRecordSummary(recordId) {
      const customer = window.AppCustomerManager.getCustomerById(customerId);
      const record = window.AppRecordManager.getRecordById(customerId, recordId);
      if (!customer || !record) return;

      const lines = ['ã€æœ¬æ¬¡æœå‹™æ‘˜è¦ã€‘'];
      lines.push(`æ—¥æœŸï¼š${new Date(record.createdAt).toLocaleDateString()}`);
      
      const complaint = record.steps?.chiefComplaint?.complaint;
      if (complaint?.trim()) lines.push(`ä¸»è¨´ï¼š${complaint.trim()}`);

      if (customer.healthTags?.length > 0) lines.push(`å—å‚·å²ï¼š${customer.healthTags.join('ã€')}`);

      const assessment = record.steps?.assessment?.findings;
      if (assessment?.trim()) lines.push(`è©•ä¼°ï¼š${assessment.trim()}`);

      const treatment = record.steps?.treatment?.treatmentPlan;
      if (treatment?.trim()) lines.push(`è™•ç†éç¨‹ï¼š${treatment.trim()}`);

      if (customer.location?.trim()) lines.push(`å±…ä½åœ°ï¼š${customer.location.trim()}`);
      if (customer.occupation?.trim()) lines.push(`è·æ¥­ï¼š${customer.occupation.trim()}`);

      const interestsList = customer.interests || customer.interestTags;
      if (interestsList?.length > 0) lines.push(`èˆˆè¶£ï¼š${interestsList.join('ã€')}`);

      navigator.clipboard.writeText(lines.join('\n')).then(() => {
        showToast('æ‘˜è¦å·²è¤‡è£½ï¼', 'success');
      }).catch(err => showToast('è¤‡è£½å¤±æ•—', 'error'));
    }

    function setupIntersectionObserver() {
      if (observer) observer.disconnect();
      const trigger = document.getElementById('load-more-trigger');
      if (!trigger) return;

      observer = new IntersectionObserver((entries) => {
        const entry = entries[0];
        if (entry.isIntersecting && !isLoading && displayedRecords.length < filteredRecords.length) {
          isLoading = true;
          setTimeout(() => { renderRecords(true); }, 300);
        }
      }, { root: null, rootMargin: '100px', threshold: 0.1 });
      observer.observe(trigger);
    }


    // ===== äº‹ä»¶ç›£è½æ•´åˆ =====
    function attachEventListeners() {
      document.getElementById('back-btn').addEventListener('click', () => {
        window.location.href = 'customer-list.html';
      });
      
      // é€™è£¡åªéœ€è¦ç¶å®šä¸€æ¬¡
      document.getElementById('edit-btn').addEventListener('click', () => {
        openEditModal();
      });
      
      // ä½¿ç”¨ Event Listener å–ä»£ onclick (æ›´å®‰å…¨)
      const addBtn = document.getElementById('add-record-btn');
      if(addBtn) {
          addBtn.addEventListener('click', () => window.goToAddRecord());
      }
      
      document.getElementById('search-input').addEventListener('input', applyFilters);
      document.getElementById('sort-select').addEventListener('change', applyFilters);
    }

    // ===== å·¥å…·å‡½å¼ =====
    function formatDate(isoString) {
      if(!isoString) return '-';
      const date = new Date(isoString);
      return `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')}`;
    }

    function formatDateTime(isoString) {
      if(!isoString) return '-';
      const date = new Date(isoString);
      return `${formatDate(isoString)} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
    }

    function formatGender(gender) {
      const genderMap = { 'male': 'ç”·', 'female': 'å¥³', 'other': 'å¤šå…ƒ' };
      return genderMap[gender] || '-';
    }

    function viewRecord(recordId) {
     window.location.href = `service-record.html?customerId=${customerId}&recordId=${recordId}&mode=edit`;
    }

    function editRecord(recordId) {
      window.location.href = `service-record.html?customerId=${customerId}&recordId=${recordId}&mode=edit`;
    }

    async function deleteRecord(recordId) {
      if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ç´€éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) return;
      try {
        const result = await window.AppRecordManager.deleteRecord(customerId, recordId);
        if (result.success) {
          showToast('ç´€éŒ„å·²åˆªé™¤', 'success');
          loadServiceRecords(customerId);
          loadCustomerProfile(); 
        } else {
          showToast(`åˆªé™¤å¤±æ•—ï¼š${result.error}`, 'error');
        }
      } catch (e) {
        console.error(e);
        showToast('åˆªé™¤éç¨‹ç™¼ç”ŸéŒ¯èª¤', 'error');
      }
    }

    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    // ===== Modal é‚è¼¯ =====
    function openEditModal() {
      const customer = window.AppCustomerManager.getCustomerById(customerId);
      if (!customer) return;

      document.getElementById('edit-cid').value = customer.id;
      document.getElementById('edit-cname').value = customer.name;
      document.getElementById('edit-cnickname').value = customer.nickname || '';
      document.getElementById('edit-cphone').value = customer.phoneLastThree || '';
      document.getElementById('edit-cgender').value = customer.gender || 'male';
      document.getElementById('edit-cage').value = customer.age || '';
      document.getElementById('edit-coccupation').value = customer.occupation || '';
      document.getElementById('edit-clocation').value = customer.location || '';
       
      document.getElementById('edit-chealth').value = (customer.healthTags || []).join(', ');
      document.getElementById('edit-cinterests').value = (customer.interestTags || customer.interests || []).join(', ');

      document.getElementById('edit-customer-modal').style.display = 'flex';
    }

    function closeEditModal() {
      document.getElementById('edit-customer-modal').style.display = 'none';
    }

    function handleUpdateCustomer(e) {
      e.preventDefault();
      const parseTags = (str) => str.split(/[,ï¼Œã€]/).map(s => s.trim()).filter(s => s.length > 0);

      const updatedData = {
        name: document.getElementById('edit-cname').value,
        nickname: document.getElementById('edit-cnickname').value,
        phoneLastThree: document.getElementById('edit-cphone').value,
        gender: document.getElementById('edit-cgender').value,
        age: document.getElementById('edit-cage').value,
        occupation: document.getElementById('edit-coccupation').value,
        location: document.getElementById('edit-clocation').value,
        healthTags: parseTags(document.getElementById('edit-chealth').value),
        interests: parseTags(document.getElementById('edit-cinterests').value)
      };

      const result = window.AppCustomerManager.updateCustomer(customerId, updatedData);
      
      if (result.success) {
        showToast('è³‡æ–™æ›´æ–°æˆåŠŸ', 'success');
        closeEditModal();
        loadCustomerProfile(); 
      } else {
        showToast('æ›´æ–°å¤±æ•—: ' + result.errors.join(','), 'error');
      }
    }
  </script>

  <div id="edit-customer-modal" class="modal-overlay" style="display:none;">
    <div class="modal-content" style="background:white; padding:20px; border-radius:12px; max-width:500px; width:90%;">
      <div class="modal-header" style="display:flex; justify-content:space-between; margin-bottom:20px;">
        <h3 style="margin:0;">ç·¨è¼¯é¡§å®¢è³‡æ–™</h3>
        <button onclick="closeEditModal()" style="background:none;border:none;font-size:24px;cursor:pointer;">Ã—</button>
      </div>
      <form id="edit-customer-form" onsubmit="handleUpdateCustomer(event)">
        <input type="hidden" id="edit-cid">
        <div class="form-group" style="margin-bottom:15px;">
          <label style="display:block;margin-bottom:5px;font-weight:bold;">å§“å *</label>
          <input type="text" id="edit-cname" required style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;">
        </div>
        <div class="form-group" style="margin-bottom:15px;">
          <label style="display:block;margin-bottom:5px;font-weight:bold;">æš±ç¨±</label>
          <input type="text" id="edit-cnickname" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;">
        </div>
        <div class="form-group" style="margin-bottom:15px;">
          <label style="display:block;margin-bottom:5px;font-weight:bold;">é›»è©±æœ«ä¸‰ç¢¼</label>
          <input type="text" id="edit-cphone" maxlength="3" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;">
        </div>
        <div class="form-group" style="margin-bottom:15px; display:flex; gap:10px;">
          <div style="flex:1;">
             <label style="display:block;margin-bottom:5px;font-weight:bold;">æ€§åˆ¥</label>
             <select id="edit-cgender" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;">
               <option value="male">ç”·</option>
               <option value="female">å¥³</option>
               <option value="other">å¤šå…ƒ</option>
             </select>
          </div>
          <div style="flex:1;">
             <label style="display:block;margin-bottom:5px;font-weight:bold;">å¹´é½¡</label>
             <input type="number" id="edit-cage" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;">
          </div>
        </div>
        <div class="form-group" style="margin-bottom:15px;">
          <label style="display:block;margin-bottom:5px;font-weight:bold;">è·æ¥­</label>
          <input type="text" id="edit-coccupation" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;">
        </div>
        <div class="form-group" style="margin-bottom:15px;">
          <label style="display:block;margin-bottom:5px;font-weight:bold;">å±…ä½åœ°</label>
          <input type="text" id="edit-clocation" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;">
        </div>
        <div style="border-top:1px solid #eee; margin: 15px 0; padding-top:10px;">
          <div class="form-group" style="margin-bottom:15px;">
            <label style="display:block;margin-bottom:5px;font-weight:bold; color:#D32F2F;">å—å‚·å²/å¥åº·ç‹€æ…‹ (é€—è™Ÿåˆ†éš”)</label>
            <input type="text" id="edit-chealth" placeholder="ä¾‹å¦‚: é«˜è¡€å£“, éª¨æŠ˜" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;">
          </div>
          <div class="form-group" style="margin-bottom:15px;">
            <label style="display:block;margin-bottom:5px;font-weight:bold; color:#7B1FA2;">æ—¥å¸¸æ´»å‹• (é€—è™Ÿåˆ†éš”)</label>
            <input type="text" id="edit-cinterests" placeholder="ä¾‹å¦‚: è·‘æ­¥, æ¸¸æ³³" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;">
          </div>
      </div>
        <div style="text-align:right;">
          <button type="button" onclick="closeEditModal()" class="btn" style="background:#eee;color:#333;margin-right:10px;">å–æ¶ˆ</button>
          <button type="submit" class="btn btn-primary">å„²å­˜è®Šæ›´</button>
        </div>
      </form>
    </div>
  </div>
</body>
</html>